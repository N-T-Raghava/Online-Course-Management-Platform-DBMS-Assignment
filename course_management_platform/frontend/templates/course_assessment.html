{% extends 'base.html' %}

{% block title %}{{ course.title }} - Final Quiz{% endblock %}

{% block extra_css %}
<style>
    .quiz-container { max-width: 900px; margin: 20px auto; }
    .loading-spinner { display: flex; justify-content: center; align-items: center; gap: 10px; padding: 40px 20px; }
    .spinner { width: 24px; height: 24px; border: 3px solid var(--border-color); border-top-color: var(--primary-color); border-radius: 50%; animation: spin 0.8s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .error-message { background: #f8d7da; color: #721c24; padding: 12px; border-radius: 6px; margin: 12px 0; }
    .question-card { background: white; padding: 16px; border-radius: 8px; margin-bottom: 12px; box-shadow: var(--shadow); }
    .question-number { font-weight: 700; margin-right: 8px; }
    .options { display: flex; gap: 12px; flex-wrap: wrap; margin-top:8px; }
    .option { padding: 10px 12px; border-radius: 6px; border: 1px solid var(--border-color); cursor: pointer; transition: all 0.2s; }
    .option:hover { background: var(--light-color); }
    .option input { margin-right: 6px; cursor: pointer; }
    .option input:checked { color: var(--primary-color); }
    .result-panel { background: white; padding: 18px; border-radius: 8px; box-shadow: var(--shadow); margin-top: 16px; }
    .rating-stars { font-size: 22px; color: #ffc107; cursor: pointer; }
    .review-actions { margin-top: 12px; display:flex; gap:8px; align-items:center; }
    .alert { padding: 12px; border-radius: 6px; margin-bottom: 12px; }
    .alert-success { background: #d1e7dd; color: #0a3622; border: 1px solid #badbcc; }
    .alert-danger { background: #f8d7da; color: #721c24; border: 1px solid #f5c2c7; }
    .alert-warning { background: #fff3cd; color: #664d03; border: 1px solid #ffecb5; }
    .rating-star { font-size: 28px; cursor: pointer; transition: color 0.2s, transform 0.2s; }
    .rating-star:hover { color: #ffc107; transform: scale(1.2); }
</style>
{% endblock %}

{% block content %}
<div class="quiz-container">
    <div class="card">
        <div class="card-body">
            <h3>{{ course.title }} — Final Assessment</h3>
            <p class="text-muted" id="quizDescription">Loading quiz...</p>

            <form id="quizForm">
                <div id="quizLoading" class="loading-spinner">
                    <div class="spinner"></div>
                    <span>Loading quiz questions...</span>
                </div>
                <div id="quizContent" style="display: none;"></div>

                <div id="formActions" style="display:none; display:flex; gap:10px; align-items:center; margin-top: 20px;">
                    <button type="button" id="scoreBtn" class="btn btn-primary">Submit Quiz</button>
                    <div id="loadingScore" style="display:none;">Submitting...</div>
                </div>
            </form>

            <div id="resultArea" style="display:none;" class="result-panel">
                <h4 id="scoreText"></h4>
                <p id="gradeText"></p>
                <div id="completionBanner" style="display:none;" class="alert alert-success">✨ <strong>Course completed successfully!</strong> You can now review your answers below.</div>

                <hr>
                <h5>Rate & Review</h5>
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">Your Rating:</label>
                    <div id="stars" style="display:flex; gap:8px; margin-bottom: 12px;">
                        <span class="rating-star" data-value="1">☆</span>
                        <span class="rating-star" data-value="2">☆</span>
                        <span class="rating-star" data-value="3">☆</span>
                        <span class="rating-star" data-value="4">☆</span>
                        <span class="rating-star" data-value="5">☆</span>
                    </div>
                    <div id="rating-display" style="margin-bottom: 12px; font-weight: 500; color: #667eea;">No rating selected</div>
                    
                    <label for="reviewText" style="display: block; margin-bottom: 8px; font-weight: 500;">Your Review (optional):</label>
                    <textarea id="reviewText" class="form-control" rows="3" placeholder="Share your thoughts about this course..."></textarea>
                    <div class="review-actions">
                        <label><input type="checkbox" id="isPublic"> Make review public</label>
                        <button type="button" id="submitReviewBtn" class="btn btn-success">Submit Review</button>
                    </div>
                    <div id="reviewMsg" style="margin-top:8px;"></div>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/quiz.js') }}"></script>
<script>
    const courseId = {{ course.course_id }};
    const userId = {{ current_user.user_id }};
    const token = '{{ auth_token }}';

    // Initialize quiz on page load
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            await loadQuiz();
        } catch (error) {
            console.error('Failed to load quiz:', error);
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = 'Failed to load quiz. Please refresh the page or contact support.';
            document.getElementById('quizLoading').replaceWith(errorDiv);
        }
    });

    /**
     * Load quiz from backend API and render questions
     */
    async function loadQuiz() {
        try {
            // Fetch quiz for this course
            const quizData = await window.QuizAPI.getQuizForCourse(courseId, token);
            
            if (!quizData || !quizData.questions) {
                throw new Error('No quiz data received');
            }

            // Update description
            document.getElementById('quizDescription').textContent = 
                quizData.description || `${quizData.questions.length} questions. Choose one option per question.`;

            // Render quiz questions dynamically
            const quizContent = document.getElementById('quizContent');
            if (!quizContent) {
                throw new Error('Quiz content element not found in the page.');
            }
            renderQuizQuestions(quizData, quizContent);

            // Show content and button
            const quizLoading = document.getElementById('quizLoading');
            if (quizLoading) quizLoading.style.display = 'none';
            quizContent.style.display = 'block';
            
            const formActions = document.getElementById('formActions');
            if (formActions) formActions.style.display = 'flex';

            // Attach submit handler
            attachSubmitHandler();

        } catch (error) {
            console.error('Error loading quiz:', error);
            throw error;
        }
    }

    /**
     * Attach submit button handler
     */
    function attachSubmitHandler() {
        const scoreBtn = document.getElementById('scoreBtn');
        if (scoreBtn) {
            scoreBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                submitQuiz();
            });
        } else {
            console.warn('scoreBtn not found when attaching submit handler');
        }
    }

    /**
     * Submit quiz and display results
     */
    async function submitQuiz() {
        try {
            // Validate all questions answered
            const questions = window.quizQuestions || [];
            
            if (!questions || questions.length === 0) {
                alert('No quiz questions loaded. Please refresh the page.');
                return;
            }

            const answers = [];

            for (let i = 0; i < questions.length; i++) {
                const questionId = questions[i].question_id;
                
                if (!questionId) {
                    alert(`Question ${i + 1}: Missing question ID`);
                    return;
                }

                const selected = document.querySelector(`input[name="q${questionId}"]:checked`);
                
                if (!selected) {
                    alert(`Please answer all questions before submitting (Q${i + 1} is unanswered)`);
                    return;
                }

                const answer = selected.value;
                if (!answer) {
                    alert(`Question ${i + 1}: Invalid answer selected`);
                    return;
                }

                answers.push(answer);
            }

            // Show loading state
            const loadingEl = document.getElementById('loadingScore');
            const scoreBtn = document.getElementById('scoreBtn');
            if (loadingEl) loadingEl.style.display = 'inline-block';
            if (scoreBtn) scoreBtn.disabled = true;

            // Grade the quiz
            const gradingResult = gradeQuiz(answers, questions);

            // Display results
            const resultArea = document.getElementById('resultArea');
            if (!resultArea) {
                alert('Result area not found. Please refresh the page.');
                return;
            }
            
            displayQuizResults(gradingResult, resultArea);
            resultArea.style.display = 'block';

            // Scroll to results
            resultArea.scrollIntoView({ behavior: 'smooth', block: 'start' });

            // Submit to backend for record-keeping
            await submitToBackend(courseId, answers, gradingResult);

            // Store quiz result for later use in rating handler
            window.lastQuizResult = gradingResult;

            // Get elements safely
            const completionBanner = document.getElementById('completionBanner');
            const starsDiv = document.getElementById('stars');

            // Display status message based on pass/fail
            if (gradingResult.passed) {
                // Quiz passed - show success message
                if (completionBanner) completionBanner.style.display = 'block';
            } else {
                // Quiz failed - show failure message
                if (completionBanner) completionBanner.style.display = 'none';
                
                const failedMsg = document.createElement('div');
                failedMsg.className = 'alert alert-warning';
                failedMsg.innerHTML = '<strong>Quiz Not Passed</strong><p>You need to score at least 70% to pass. You will be returned to the learning page to review the materials. Please try again when ready.</p>';
                resultArea.insertBefore(failedMsg, resultArea.firstChild);
                
                // Reset progress to first topic
                await resetProgressToStart();
            }

            // Always show rating form and scroll to it so the user sees it immediately
            if (starsDiv) {
                starsDiv.style.display = 'flex';
                try { starsDiv.scrollIntoView({ behavior: 'smooth', block: 'center' }); } catch (e) {}
            }
            setupRatingStars();

        } catch (error) {
            console.error('Error submitting quiz:', error);
            console.error('Error stack:', error.stack);
            alert('Failed to submit quiz: ' + (error.message || 'Unknown error'));
        } finally {
            const loadingEl = document.getElementById('loadingScore');
            const scoreBtn = document.getElementById('scoreBtn');
            if (loadingEl) loadingEl.style.display = 'none';
            if (scoreBtn) scoreBtn.disabled = false;
        }
    }

    /**
     * Reset progress to first topic on quiz failure
     */
    async function resetProgressToStart() {
        try {
            const response = await fetch(`/api/progress/reset/${courseId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include'
            });

            if (!response.ok) {
                console.warn('Failed to reset progress:', response.status);
            }
        } catch (error) {
            console.warn('Could not reset progress:', error);
        }
    }

    /**
     * Submit quiz results to backend for tracking
     */
    async function submitToBackend(courseId, answers, gradingResult) {
        try {
            const response = await fetch(`/api/progress/submit/${courseId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    answers: answers,
                    score: gradingResult.percentage,
                    grade: mapScoreToGrade(gradingResult.correctCount),
                    passed: gradingResult.passed
                })
            });

            if (!response.ok) {
                console.warn('Failed to submit to backend:', response.status);
            }
        } catch (error) {
            console.warn('Could not submit quiz to backend:', error);
            // Don't fail UX if backend submission fails
        }
    }

    /**
     * Setup rating stars interaction
     */
    function setupRatingStars() {
        let selectedRating = 0;
        
        const starsContainer = document.getElementById('stars');
        if (!starsContainer) {
            console.warn('Rating stars container not found');
            return;
        }
        const starNodes = starsContainer.querySelectorAll('.rating-star') || [];
        const ratingDisplay = document.getElementById('rating-display');
        if (!ratingDisplay) {
            console.warn('Rating display element not found');
        }
        
        // Add hover effect
        starNodes.forEach((star, index) => {
            star.addEventListener('mouseover', () => {
                starNodes.forEach((s, idx) => {
                    if (idx < index + 1) {
                        s.style.color = '#ffc107';
                    } else {
                        s.style.color = '#ddd';
                    }
                });
            });
            
            star.addEventListener('click', () => {
                selectedRating = parseInt(star.getAttribute('data-value'));
                updateStars(selectedRating, starNodes);
                ratingDisplay.textContent = `${selectedRating} star${selectedRating > 1 ? 's' : ''} selected`;
            });
        });
        
        starsContainer.addEventListener('mouseout', () => {
            updateStars(selectedRating, starNodes);
            if (selectedRating === 0 && ratingDisplay) {
                ratingDisplay.textContent = 'No rating selected';
            }
        });

        const submitReviewBtn = document.getElementById('submitReviewBtn');
        if (submitReviewBtn) {
            submitReviewBtn.addEventListener('click', async () => {
                if (selectedRating <= 0) {
                    const reviewMsgEl = document.getElementById('reviewMsg');
                    if (reviewMsgEl) reviewMsgEl.innerHTML = '<span style="color: #dc3545;">Please select a rating</span>';
                    return;
                }

                const reviewTextEl = document.getElementById('reviewText');
                const reviewText = reviewTextEl ? reviewTextEl.value || '' : '';
                const isPublicEl = document.getElementById('isPublic');
                const isPublic = isPublicEl ? isPublicEl.checked : false;

                submitReviewBtn.disabled = true;
                submitReviewBtn.textContent = 'Submitting...';
                const reviewMsgEl = document.getElementById('reviewMsg');
                if (reviewMsgEl) reviewMsgEl.innerHTML = '';

                try {
                    const response = await fetch(`/api/progress/rate/${courseId}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify({
                            rating: selectedRating,
                            review_text: reviewText,
                            is_public: isPublic
                        })
                    });

                    if (response.ok) {
                        document.getElementById('reviewMsg').innerHTML = 
                            '<span style="color: #28a745; font-weight: 500;">✓ Thank you — your review was submitted.</span>';
                        
                            // Determine redirect URL based on quiz result
                            const quizResult = window.lastQuizResult || {};
                            const redirectUrl = quizResult.passed ? '/dashboard' : `/course/${courseId}/learn`;
                        
                            // Redirect after 2 seconds
                        setTimeout(() => {
                                window.location.href = redirectUrl;
                        }, 2000);
                    } else {
                        const errorData = await response.json().catch(() => ({}));
                        document.getElementById('reviewMsg').innerHTML = 
                            `<span style="color: #dc3545;">Failed to submit review: ${errorData.error || 'Unknown error'}</span>`;
                        submitReviewBtn.disabled = false;
                        submitReviewBtn.textContent = 'Submit Review';
                    }
                } catch (error) {
                    console.error('Error submitting review:', error);
                    document.getElementById('reviewMsg').innerHTML = 
                        `<span style="color: #dc3545;">Failed to submit review. Please try again.</span>`;
                    submitReviewBtn.disabled = false;
                    submitReviewBtn.textContent = 'Submit Review';
                }
            });
        } else {
            console.warn('submitReviewBtn not found when setting up rating stars');
        }
    }

    /**
     * Update star display
     */
    function updateStars(rating, starNodes) {
        starNodes.forEach((star, idx) => {
            if (idx < rating) {
                star.textContent = '★';
                star.style.color = '#ffc107';
            } else {
                star.textContent = '☆';
                star.style.color = '#ddd';
            }
        });
    }
</script>
{% endblock %}
