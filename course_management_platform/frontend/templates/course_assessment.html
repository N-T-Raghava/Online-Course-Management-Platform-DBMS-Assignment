{% extends 'base.html' %}

{% block title %}{{ course.title }} - Final Quiz{% endblock %}

{% block extra_css %}
<style>
    .quiz-container { max-width: 900px; margin: 20px auto; }
    .question-card { background: white; padding: 16px; border-radius: 8px; margin-bottom: 12px; box-shadow: var(--shadow); }
    .question-number { font-weight: 700; margin-right: 8px; }
    .options { display: flex; gap: 12px; flex-wrap: wrap; margin-top:8px; }
    .option { padding: 8px 12px; border-radius: 6px; border: 1px solid var(--border-color); cursor: pointer; }
    .option input { margin-right: 6px; }
    .result-panel { background: white; padding: 18px; border-radius: 8px; box-shadow: var(--shadow); margin-top: 16px; }
    .rating-stars { font-size: 22px; color: #ffc107; cursor: pointer; }
    .review-actions { margin-top: 12px; display:flex; gap:8px; align-items:center; }
</style>
{% endblock %}

{% block content %}
<div class="quiz-container">
    <div class="card">
        <div class="card-body">
            <h3>{{ course.title }} — Final Assessment</h3>
            <p class="text-muted">15 multiple-choice questions. Choose one option per question.</p>

            <form id="quizForm">
                {% for i in range(1,16) %}
                <div class="question-card">
                    <div>
                        <span class="question-number">Q{{ i }}.</span>
                        <span>Placeholder question {{ i }} — Explain or test concept {{ i }}.</span>
                    </div>
                    <div class="options">
                        <label class="option"><input type="radio" name="q{{ i }}" value="A"> A</label>
                        <label class="option"><input type="radio" name="q{{ i }}" value="B"> B</label>
                        <label class="option"><input type="radio" name="q{{ i }}" value="C"> C</label>
                        <label class="option"><input type="radio" name="q{{ i }}" value="D"> D</label>
                    </div>
                </div>
                {% endfor %}

                <div style="display:flex; gap:10px; align-items:center;">
                    <button type="button" id="scoreBtn" class="btn btn-primary">Get Score</button>
                    <div id="loadingScore" style="display:none;">Submitting...</div>
                </div>
            </form>

            <div id="resultArea" style="display:none;" class="result-panel">
                <h4 id="scoreText"></h4>
                <p id="gradeText"></p>
                <div id="completionBanner" style="display:none;" class="alert alert-success">Course completed successfully.</div>

                <hr>
                <h5>Rate & Review</h5>
                <div>
                    <div id="stars" style="display:flex; gap:6px;">
                        <span class="rating-stars" data-value="1">☆</span>
                        <span class="rating-stars" data-value="2">☆</span>
                        <span class="rating-stars" data-value="3">☆</span>
                        <span class="rating-stars" data-value="4">☆</span>
                        <span class="rating-stars" data-value="5">☆</span>
                    </div>
                    <textarea id="reviewText" class="form-control" rows="3" placeholder="Write your review (optional)"></textarea>
                    <div class="review-actions">
                        <label><input type="checkbox" id="isPublic"> Make review public</label>
                        <button id="submitReviewBtn" class="btn btn-success">Submit Review</button>
                    </div>
                    <div id="reviewMsg" style="margin-top:8px;"></div>
                </div>
            </div>

        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const courseId = {{ course.course_id }};
    const userId = {{ current_user.user_id }};
    const token = '{{ auth_token }}';
    const answerKey = '{{ course.quiz_answer_key or "" }}';

    function mapScoreToGrade(scoreCount){
        // scoreCount is 0..15
        if (scoreCount >= 13) return 'A';
        if (scoreCount >= 10) return 'B';
        if (scoreCount >= 7) return 'C';
        if (scoreCount >= 4) return 'D';
        return 'F';
    }

    document.getElementById('scoreBtn').addEventListener('click', async () => {
        // collect answers
        const answers = [];
        for (let i=1;i<=15;i++){
            const el = document.querySelector(`input[name="q${i}"]:checked`);
            if (!el){ alert('Please answer all questions before submitting'); return; }
            answers.push(el.value);
        }

        // show local score (client-side validation for UX)
        if (!answerKey || answerKey.length < 15){ alert('No answer key configured for this course'); return; }
        let correct = 0;
        for (let i=0;i<15;i++){
            const expected = answerKey.charAt(i).toUpperCase();
            if (answers[i] && answers[i].toUpperCase() === expected) correct++;
        }
        document.getElementById('scoreText').textContent = `You scored ${correct} / 15`;
        const grade = mapScoreToGrade(correct);
        document.getElementById('gradeText').textContent = `Grade: ${grade}`;
        document.getElementById('resultArea').style.display='block';

        // submit answers to backend (server validates and returns grade + completion)
        document.getElementById('loadingScore').style.display='inline-block';
        const resp = await fetch(`/api/progress/submit/${courseId}`,{
            method:'POST', 
            headers:{'Content-Type':'application/json'}, 
            body: JSON.stringify({answers: answers})
        });
        document.getElementById('loadingScore').style.display='none';

        if (resp.ok){
            const data = await resp.json();
            // server returns: score (%), grade (A-F), completion_status
            if (data.score !== undefined) document.getElementById('scoreText').textContent = `You scored ${Math.round(data.score / (100/15))} / 15 (${data.score}%)`;
            if (data.grade) document.getElementById('gradeText').textContent = `Grade: ${data.grade}`;
            if (data.completion_status && data.completion_status.toLowerCase()==='completed'){
                document.getElementById('completionBanner').style.display='block';
            }
        } else {
            try {
                const errData = await resp.json();
                console.error('Assessment submission error:', errData);
                alert(`Failed to submit assessment: ${errData.error || 'Unknown error'}`);
            } catch (e) {
                console.error('Assessment submission failed:', e);
                alert('Failed to submit assessment - please check the console for details');
            }
        }
    });

    // rating stars
    let selectedRating = 0;
    document.querySelectorAll('#stars .rating-stars').forEach(s => {
        s.addEventListener('click', ()=>{
            selectedRating = parseInt(s.getAttribute('data-value'));
            document.querySelectorAll('#stars .rating-stars').forEach(x => x.textContent = '☆');
            for (let i=0;i<selectedRating;i++) document.querySelectorAll('#stars .rating-stars')[i].textContent = '★';
        });
    });

    document.getElementById('submitReviewBtn').addEventListener('click', async ()=>{
        if (selectedRating <=0){ document.getElementById('reviewMsg').textContent='Please select a rating'; return; }
        const reviewText = document.getElementById('reviewText').value || '';
        const isPublic = document.getElementById('isPublic').checked;

        // POST to frontend API (include is_public flag)
        const resp = await fetch(`/api/progress/rate/${courseId}`,{
            method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({rating:selectedRating, review_text: reviewText, is_public: isPublic})
        });

        if (resp.ok){
            document.getElementById('reviewMsg').textContent = 'Thank you — your review was submitted.';
        } else {
            const errData = await resp.json().catch(() => ({}));
            const errMsg = errData.error || `Server error: ${resp.status}`;
            console.error('Review submission failed:', errMsg);
            document.getElementById('reviewMsg').textContent = `Failed to submit review: ${errMsg}`;
        }
    });
</script>
{% endblock %}
