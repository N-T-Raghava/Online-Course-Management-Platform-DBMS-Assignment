{% extends "base.html" %}

{% block title %}Edit Course - {{ course.course_title }}{% endblock %}

{% block extra_css %}
<style>
    .edit-course-banner {
        background: linear-gradient(135deg, #17a2b8, #138496);
        color: white;
        padding: 40px 20px;
        border-radius: 8px;
        margin-bottom: 40px;
        box-shadow: var(--shadow);
    }

    .edit-course-banner h1 {
        font-size: 32px;
        margin: 0 0 8px 0;
        font-weight: 700;
    }

    .edit-course-banner p {
        margin: 0;
        font-size: 14px;
        opacity: 0.95;
    }

    .edit-container {
        background: white;
        border-radius: 8px;
        box-shadow: var(--shadow);
        padding: 0;
        margin-bottom: 40px;
    }

    .edit-tabs {
        display: flex;
        border-bottom: 2px solid var(--border-color);
        padding: 0;
    }

    .edit-tab {
        flex: 1;
        padding: 16px 20px;
        text-align: center;
        cursor: pointer;
        border: none;
        background: none;
        font-weight: 600;
        color: var(--text-muted);
        transition: all 0.2s ease;
        border-bottom: 3px solid transparent;
        margin-bottom: -2px;
    }

    .edit-tab.active {
        color: #17a2b8;
        border-bottom-color: #17a2b8;
    }

    .edit-tab:hover {
        color: #17a2b8;
    }

    .edit-tab-content {
        padding: 32px;
        display: none;
    }

    .edit-tab-content.active {
        display: block;
    }

    .form-section {
        margin-bottom: 40px;
    }

    .form-section h3 {
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 20px;
        color: var(--dark-color);
        padding-bottom: 12px;
        border-bottom: 2px solid #F0F0F0;
    }

    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-group {
        display: flex;
        flex-direction: column;
    }

    .form-group.full-width {
        grid-column: 1 / -1;
    }

    .form-group label {
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--dark-color);
        font-size: 14px;
    }

    .form-group input,
    .form-group textarea,
    .form-group select {
        padding: 12px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 14px;
        font-family: inherit;
        transition: var(--transition);
    }

    .form-group input:focus,
    .form-group textarea:focus,
    .form-group select:focus {
        outline: none;
        border-color: #17a2b8;
        box-shadow: 0 0 0 3px rgba(23, 162, 184, 0.1);
    }

    .form-group textarea {
        min-height: 100px;
        resize: vertical;
    }

    .topic-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .topic-item {
        background: #f8f9fa;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .topic-info h5 {
        margin: 0 0 4px 0;
        font-size: 15px;
        color: var(--text-color);
    }

    .topic-info p {
        margin: 0;
        font-size: 13px;
        color: var(--text-muted);
    }

    .topic-actions {
        display: flex;
        gap: 8px;
    }

    .btn-delete {
        background: #dc3545;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-delete:hover {
        background: #c82333;
        transform: translateY(-1px);
    }

    .btn-add {
        background: #17a2b8;
        color: white;
        border: none;
        padding: 10px 16px;
        border-radius: 4px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s ease;
        margin-top: 12px;
    }

    .btn-add:hover {
        background: #138496;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
    }

    .btn-save {
        background: #28a745;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 4px;
        font-weight: 600;
        font-size: 15px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .btn-save:hover {
        background: #218838;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
    }

    .btn-save:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .alert {
        padding: 12px 16px;
        border-radius: 6px;
        margin-bottom: 20px;
        font-size: 14px;
    }

    .alert-success {
        background: #d1e7dd;
        color: #0a3622;
        border: 1px solid #badbcc;
    }

    .alert-danger {
        background: #f8d7da;
        color: #842029;
        border: 1px solid #f5c2c7;
    }

    .content-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-top: 20px;
    }

    .content-item {
        background: #f8f9fa;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 16px;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    .content-info h5 {
        margin: 0 0 4px 0;
        font-size: 15px;
        color: var(--text-color);
    }

    .content-info p {
        margin: 0;
        font-size: 13px;
        color: var(--text-muted);
    }

    .content-type-badge {
        display: inline-block;
        background: #17a2b8;
        color: white;
        padding: 4px 8px;
        border-radius: 3px;
        font-size: 11px;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .add-topic-form,
    .add-form {
        background: #f8f9fa;
        border: 1px solid var(--border-color);
        border-radius: 6px;
        padding: 16px;
        margin-top: 16px;
    }

    .loading-spinner {
        display: inline-block;
        width: 14px;
        height: 14px;
        border: 2px solid rgba(23, 162, 184, 0.3);
        border-radius: 50%;
        border-top-color: #17a2b8;
        animation: spin 0.8s linear infinite;
        margin-right: 8px;
        vertical-align: middle;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .tabs-button-group {
        display: flex;
        gap: 12px;
        margin-top: 20px;
        flex-wrap: wrap;
    }
</style>
{% endblock %}

{% block content %}
<div class="edit-course-banner">
    <h1>‚úèÔ∏è Edit Course</h1>
    <p>Update course details, manage topics, and organize learning materials</p>
</div>

<div class="edit-container">
    <!-- Tabs -->
    <div class="edit-tabs">
        <button class="edit-tab active" data-tab="details">üìã Course Details</button>
        <button class="edit-tab" data-tab="topics">üìö Topics</button>
        <button class="edit-tab" data-tab="content">üìñ Course Content</button>
    </div>

    <!-- Tab: Course Details -->
    <div id="details" class="edit-tab-content active">
        <div id="detailsAlert"></div>

        <div class="form-section">
            <h3>Basic Information</h3>
            
            <div class="form-row">
                <div class="form-group full-width">
                    <label for="courseTitle">Course Title <span style="color: #dc3545;">*</span></label>
                    <input type="text" id="courseTitle" value="{{ course.course_title }}" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group full-width">
                    <label for="courseDesc">Description</label>
                    <textarea id="courseDesc">{{ course.description or '' }}</textarea>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="courseCategory">Category</label>
                    <input type="text" id="courseCategory" value="{{ course.category or '' }}">
                </div>
                <div class="form-group">
                    <label for="courseLevel">Level</label>
                    <select id="courseLevel">
                        <option value="">-- Select Level --</option>
                        <option value="Beginner" {% if course.level == 'Beginner' %}selected{% endif %}>Beginner</option>
                        <option value="Intermediate" {% if course.level == 'Intermediate' %}selected{% endif %}>Intermediate</option>
                        <option value="Advanced" {% if course.level == 'Advanced' %}selected{% endif %}>Advanced</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="courseLanguage">Language</label>
                    <input type="text" id="courseLanguage" value="{{ course.language or '' }}">
                </div>
                <div class="form-group">
                    <label for="courseDuration">Duration (hours)</label>
                    <input type="number" id="courseDuration" value="{{ course.duration or 0 }}" min="0">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="courseUniversity">University</label>
                    <select id="courseUniversity">
                        <option value="">-- Select University --</option>
                        {% for uni in universities %}
                        <option value="{{ uni.university_id }}" {% if course.university_id == uni.university_id %}selected{% endif %}>{{ uni.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div class="tabs-button-group">
                <button class="btn-save" onclick="saveBasicInfo()">
                    <span id="saveBasicText">Save Changes</span>
                </button>
                <a href="{{ url_for('instructor_dashboard') }}" class="btn-save" style="background: #6c757d; text-decoration: none;">Cancel</a>
            </div>
        </div>
    </div>

    <!-- Tab: Topics -->
    <div id="topics" class="edit-tab-content">
        <div id="topicsAlert"></div>

        <div class="form-section">
            <h3>Manage Course Topics</h3>
            
            <div class="topic-list" id="topicsList">
                <div style="text-align: center; color: var(--text-muted); padding: 20px;">
                    <div class="loading-spinner"></div>
                    Loading topics...
                </div>
            </div>

            <div class="add-topic-form" id="addTopicForm" style="display: none;">
                <h4 style="margin: 0 0 16px 0; font-size: 15px;">Add New Topic</h4>
                <div class="form-group">
                    <label for="newTopicName">Topic Name <span style="color: #dc3545;">*</span></label>
                    <input type="text" id="newTopicName" placeholder="e.g., Introduction to Python" required>
                </div>
                <div class="form-group">
                    <label for="newTopicDesc">Description (Optional)</label>
                    <textarea id="newTopicDesc" placeholder="Describe this topic..." style="min-height: 80px;"></textarea>
                </div>
                <div style="display: flex; gap: 12px;">
                    <button class="btn-add" onclick="addTopic()">Add Topic</button>
                    <button class="btn-add" onclick="cancelAddTopic()" style="background: #6c757d;">Cancel</button>
                </div>
            </div>

            <button class="btn-add" id="addTopicBtn" onclick="showAddTopicForm()">+ Add New Topic</button>
        </div>
    </div>

    <!-- Tab: Course Content -->
    <div id="content" class="edit-tab-content">
        <div id="contentAlert"></div>

        <div class="form-section">
            <h3>Course Materials</h3>
            <p style="color: var(--text-muted); font-size: 14px; margin-bottom: 20px;">
                View and manage all course content. Visit the course detail page to add or delete specific content items.
            </p>

            <div class="content-list" id="contentList">
                {% if course_content and course_content|length > 0 %}
                    {% for item in course_content %}
                    <div class="content-item">
                        <div class="content-info">
                            <span class="content-type-badge">{{ item.content_type }}</span>
                            <h5>{{ item.title }}</h5>
                            {% if item.topic_id %}
                            <p>üìå Topic-specific</p>
                            {% else %}
                            <p>üåç Course-wide content</p>
                            {% endif %}
                        </div>
                        <div style="text-align: right;">
                            <a href="{{ item.file_url }}" target="_blank" style="color: #17a2b8; text-decoration: none; font-size: 13px;">View ‚Üó</a>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                <div style="text-align: center; padding: 40px; background: #f8f9fa; border-radius: 6px; color: var(--text-muted);">
                    <p>üìö No content uploaded yet.</p>
                    <p style="font-size: 13px; margin-top: 8px;">
                        <a href="{{ url_for('instructor_upload_content', course_id=course.course_id) }}" style="color: #17a2b8; text-decoration: none;">
                            Add course content ‚Üí
                        </a>
                    </p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    const courseId = {{ course.course_id }};
    let topics = {{ topics | tojson }};

    // Tab switching
    document.querySelectorAll('.edit-tab').forEach(tab => {
        tab.addEventListener('click', function() {
            const tabName = this.getAttribute('data-tab');
            
            // Hide all tabs
            document.querySelectorAll('.edit-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Deactivate all tab buttons
            document.querySelectorAll('.edit-tab').forEach(t => {
                t.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            this.classList.add('active');
            
            // Load topics when switching to topics tab
            if (tabName === 'topics') {
                loadTopics();
            }
        });
    });

    // Save basic info
    async function saveBasicInfo() {
        const title = document.getElementById('courseTitle').value;
        const description = document.getElementById('courseDesc').value;
        const category = document.getElementById('courseCategory').value;
        const level = document.getElementById('courseLevel').value;
        const language = document.getElementById('courseLanguage').value;
        const duration = document.getElementById('courseDuration').value;
        const universityId = document.getElementById('courseUniversity').value;

        if (!title) {
            showAlert('detailsAlert', 'Course title is required', 'danger');
            return;
        }

        const saveBtn = event.target;
        saveBtn.disabled = true;
        saveBtn.innerHTML = '<span class="loading-spinner"></span>Saving...';

        try {
            const response = await fetch(`/instructor/course/${courseId}/edit`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    title,
                    description,
                    category,
                    level,
                    language,
                    duration: duration ? parseInt(duration) : null,
                    university_id: universityId ? parseInt(universityId) : null
                })
            });

            const data = await response.json();

            if (response.ok) {
                showAlert('detailsAlert', '‚úì Course updated successfully', 'success');
            } else {
                showAlert('detailsAlert', data.error || 'Failed to update course', 'danger');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('detailsAlert', 'Network error. Please try again.', 'danger');
        } finally {
            saveBtn.disabled = false;
            saveBtn.innerHTML = 'Save Changes';
        }
    }

    // Load topics
    function loadTopics() {
        const topicsList = document.getElementById('topicsList');
        
        if (topics && topics.length > 0) {
            topicsList.innerHTML = '';
            topics.forEach((topic, index) => {
                const item = document.createElement('div');
                item.className = 'topic-item';
                item.innerHTML = `
                    <div>
                        <h5>${topic.name || topic.title}</h5>
                        ${topic.description ? `<p>${topic.description}</p>` : ''}
                    </div>
                    <div class="topic-actions">
                        <button class="btn-delete" onclick="deleteTopic(${topic.topic_id}, ${index})">Delete</button>
                    </div>
                `;
                topicsList.appendChild(item);
            });
            document.getElementById('addTopicForm').style.display = 'none';
            document.getElementById('addTopicBtn').style.display = 'block';
        } else {
            topicsList.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">No topics yet. Add your first topic below.</p>';
            document.getElementById('addTopicForm').style.display = 'block';
            document.getElementById('addTopicBtn').style.display = 'none';
        }
    }

    // Show add topic form
    function showAddTopicForm() {
        document.getElementById('addTopicForm').style.display = 'block';
        document.getElementById('addTopicBtn').style.display = 'none';
        document.getElementById('newTopicName').focus();
    }

    // Cancel add topic
    function cancelAddTopic() {
        document.getElementById('addTopicForm').style.display = 'none';
        document.getElementById('addTopicBtn').style.display = 'block';
        document.getElementById('newTopicName').value = '';
        document.getElementById('newTopicDesc').value = '';
    }

    // Add topic
    async function addTopic() {
        const name = document.getElementById('newTopicName').value;
        const description = document.getElementById('newTopicDesc').value;

        if (!name) {
            showAlert('topicsAlert', 'Topic name is required', 'danger');
            return;
        }

        try {
            const response = await fetch(`/api/course/${courseId}/topic`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ name, description })
            });

            const data = await response.json();

            if (response.ok) {
                // Add to local topics array
                topics.push({
                    topic_id: Math.max(...topics.map(t => t.topic_id), 0) + 1,
                    name,
                    description
                });
                
                loadTopics();
                cancelAddTopic();
                showAlert('topicsAlert', '‚úì Topic added successfully', 'success');
            } else {
                showAlert('topicsAlert', data.error || 'Failed to add topic', 'danger');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('topicsAlert', 'Network error. Please try again.', 'danger');
        }
    }

    // Delete topic
    async function deleteTopic(topicId, index) {
        if (!confirm('Are you sure you want to delete this topic?')) {
            return;
        }

        try {
            const response = await fetch(`/api/course/${courseId}/topic`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ topic_id: topicId })
            });

            const data = await response.json();

            if (response.ok) {
                topics.splice(index, 1);
                loadTopics();
                showAlert('topicsAlert', '‚úì Topic deleted successfully', 'success');
            } else {
                showAlert('topicsAlert', data.error || 'Failed to delete topic', 'danger');
            }
        } catch (error) {
            console.error('Error:', error);
            showAlert('topicsAlert', 'Network error. Please try again.', 'danger');
        }
    }

    // Show alert
    function showAlert(elementId, message, type) {
        const alertEl = document.getElementById(elementId);
        alertEl.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        
        setTimeout(() => {
            alertEl.innerHTML = '';
        }, 4000);
    }

    // Initialize
    window.addEventListener('DOMContentLoaded', function() {
        loadTopics();
    });
</script>
{% endblock %}
