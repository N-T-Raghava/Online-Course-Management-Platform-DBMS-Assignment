{% extends "base.html" %}

{% block title %}{{ course.course_title }} - Instructor View{% endblock %}

{% block extra_css %}
<style>
    .course-header-instructor {
        background: linear-gradient(135deg, #8B5CF6, #7C3AED);
        color: white;
        padding: 40px 20px;
        border-radius: 8px;
        margin-bottom: 30px;
        box-shadow: var(--shadow);
    }

    .course-header-instructor h1 {
        font-size: 32px;
        margin: 0 0 10px 0;
        font-weight: 700;
    }

    .course-header-meta {
        display: flex;
        gap: 20px;
        margin-top: 15px;
        flex-wrap: wrap;
    }

    .meta-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .meta-label {
        opacity: 0.9;
        font-size: 14px;
    }

    .meta-value {
        font-weight: 600;
        font-size: 15px;
    }

    .tabs-section {
        margin-bottom: 30px;
    }

    .nav-tabs {
        border-bottom: 2px solid var(--border-color);
        display: flex;
        gap: 0;
        overflow-x: auto;
        padding-bottom: 0;
    }

    .nav-tabs .nav-link {
        color: var(--text-muted);
        border: none;
        border-bottom: 3px solid transparent;
        padding: 12px 20px;
        cursor: pointer;
        font-weight: 600;
        transition: var(--transition);
        background: none;
        margin-bottom: -2px;
    }

    .nav-tabs .nav-link:hover {
        color: #8B5CF6;
    }

    .nav-tabs .nav-link.active {
        color: #8B5CF6;
        border-bottom-color: #8B5CF6;
    }

    .tab-content {
        display: none;
        animation: fadeIn 0.3s ease;
    }

    .tab-content.active {
        display: block;
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .content-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: var(--shadow);
        margin-bottom: 20px;
    }

    .content-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .content-item {
        padding: 15px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: var(--transition);
    }

    .content-item:hover {
        background: #f9f9f9;
        border-color: #8B5CF6;
    }

    .content-item-info {
        flex: 1;
    }

    .content-item-title {
        font-weight: 600;
        color: var(--dark-color);
        margin-bottom: 5px;
    }

    .content-item-meta {
        display: flex;
        gap: 15px;
        font-size: 13px;
        color: var(--text-muted);
    }

    .content-badge {
        background: #E0E7FF;
        color: #8B5CF6;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 12px;
        font-weight: 600;
    }

    .analytics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .analytics-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: var(--shadow);
        border-left: 4px solid #8B5CF6;
    }

    .analytics-card h6 {
        color: var(--text-muted);
        font-size: 12px;
        margin-bottom: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .analytics-card h3 {
        color: #8B5CF6;
        font-size: 28px;
        margin: 0;
        font-weight: 700;
    }

    .reviews-section {
        max-width: 100%;
    }

    .review-item {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: var(--shadow);
        margin-bottom: 15px;
        border-left: 4px solid #F59E0B;
    }

    .review-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 12px;
    }

    .review-author {
        font-weight: 600;
        color: var(--dark-color);
    }

    .rating-display {
        color: #F59E0B;
        font-size: 18px;
        font-weight: 600;
    }

    .review-date {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 4px;
    }

    .review-text {
        color: var(--text-color);
        line-height: 1.6;
        margin-bottom: 12px;
    }

    .students-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .student-item {
        padding: 15px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .student-info h6 {
        margin: 0 0 4px 0;
        font-weight: 600;
        color: var(--dark-color);
    }

    .student-info p {
        margin: 0;
        font-size: 12px;
        color: var(--text-muted);
    }

    .progress-badge {
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
    }

    .progress-completed {
        background: #D1FAE5;
        color: #059669;
    }

    .progress-ongoing {
        background: #FEF3C7;
        color: #D97706;
    }

    .progress-pending {
        background: #F3E8FF;
        color: #8B5CF6;
    }

    .upload-section {
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: var(--shadow);
        margin-bottom: 30px;
    }

    .upload-form-group {
        margin-bottom: 20px;
    }

    .upload-form-group label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        color: var(--dark-color);
    }

    .upload-form-group input,
    .upload-form-group textarea,
    .upload-form-group select {
        width: 100%;
        padding: 12px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-family: inherit;
        font-size: 14px;
        transition: var(--transition);
    }

    .upload-form-group input:focus,
    .upload-form-group textarea:focus,
    .upload-form-group select:focus {
        outline: none;
        border-color: #8B5CF6;
        box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
    }

    .btn-upload {
        background: #8B5CF6;
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 4px;
        font-weight: 600;
        cursor: pointer;
        transition: var(--transition);
        width: 100%;
    }

    .btn-upload:hover {
        background: #7C3AED;
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(139, 92, 246, 0.3);
    }

    .course-description {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: var(--shadow);
        margin-bottom: 30px;
        line-height: 1.6;
    }

    .course-description h6 {
        color: var(--text-muted);
        text-transform: uppercase;
        font-size: 11px;
        margin-bottom: 10px;
    }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: var(--text-muted);
    }

    .empty-state h5 {
        margin-bottom: 12px;
        color: var(--dark-color);
    }

    .back-button {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 20px;
        color: #8B5CF6;
        text-decoration: none;
        font-weight: 600;
        transition: var(--transition);
    }

    .back-button:hover {
        color: #7C3AED;
    }

    @media (max-width: 768px) {
        .course-header-instructor h1 {
            font-size: 24px;
        }

        .course-header-meta {
            flex-direction: column;
            gap: 10px;
        }

        .nav-tabs {
            flex-wrap: wrap;
        }

        .analytics-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}

{% block content %}
<a href="{{ url_for('instructor_dashboard') }}" class="back-button">← Back to Dashboard</a>

<!-- Course Header -->
<div class="course-header-instructor">
    <h1>{{ course.course_title }}</h1>
    <div class="course-header-meta">
        <div class="meta-item">
            <span class="meta-label">Level:</span>
            <span class="meta-value">{{ course.level }}</span>
        </div>
        <div class="meta-item">
            <span class="meta-label">Category:</span>
            <span class="meta-value">{{ course.category }}</span>
        </div>
        <div class="meta-item">
            <span class="meta-label">Duration:</span>
            <span class="meta-value">{{ course.duration }} hours</span>
        </div>
        <div class="meta-item">
            <span class="meta-label">Course ID:</span>
            <span class="meta-value">#{{ course.course_id }}</span>
        </div>
    </div>
</div>

<!-- Tabs Navigation -->
<div class="tabs-section">
    <div class="nav-tabs">
        <button class="nav-link active" onclick="switchTab('overview')">Overview</button>
        <button class="nav-link" onclick="switchTab('content')">Content</button>
        <button class="nav-link" onclick="switchTab('students')">Students</button>
        <button class="nav-link" onclick="switchTab('reviews')">Reviews</button>
        <button class="nav-link" onclick="switchTab('analytics')">Analytics</button>
    </div>
</div>

<!-- Overview Tab -->
<div id="overview" class="tab-content active">
    <div class="course-description">
        <h6>Course Description</h6>
        <p>{{ course.description or 'No description provided.' }}</p>
    </div>

    <div class="analytics-grid">
        <div class="analytics-card">
            <h6>Total Enrollments</h6>
            <h3>{{ analytics.total_enrollments or 0 }}</h3>
        </div>
        <div class="analytics-card">
            <h6>Completed</h6>
            <h3>{{ analytics.completed_students or 0 }}</h3>
        </div>
        <div class="analytics-card">
            <h6>In Progress</h6>
            <h3>{{ analytics.active_students or 0 }}</h3>
        </div>
        <div class="analytics-card">
            <h6>Avg Rating</h6>
            <h3>{{ analytics.average_rating or 'N/A' }}</h3>
        </div>
    </div>
</div>

<!-- Content Tab -->
<div id="content" class="tab-content">
    <div class="content-card">
        <h5 style="margin-bottom: 20px;">Course Materials</h5>
        {% if course_content and course_content|length > 0 %}
            <ul class="content-list">
                {% for material in course_content %}
                <li class="content-item">
                    <div class="content-item-info">
                        <div class="content-item-title">{{ material.title }}</div>
                        <div class="content-item-meta">
                            <span class="content-badge">{{ material.content_type or 'Document' }}</span>
                            {% if material.topic %}
                            <span>Topic: {{ material.topic }}</span>
                            {% endif %}
                        </div>
                    </div>
                    {% if material.file_url %}
                    <a href="{{ material.file_url }}" target="_blank" class="btn btn-sm btn-primary" style="padding: 6px 12px; text-decoration: none;">View</a>
                    {% endif %}
                </li>
                {% endfor %}
            </ul>
        {% else %}
            <div class="empty-state">
                <h5>No Content Uploaded Yet</h5>
                <p>Start by uploading course materials.</p>
                <a href="{{ url_for('instructor_upload_content', course_id=course.course_id) }}" class="btn btn-primary">Upload Content</a>
            </div>
        {% endif %}
    </div>

    <div class="upload-section">
        <h5 style="margin-bottom: 20px;">Upload New Content</h5>
        <form id="upload-form" onsubmit="uploadContent(event)">
            <div class="upload-form-group">
                <label>Content Title *</label>
                <input type="text" id="content-title" required placeholder="e.g., Introduction to Python">
            </div>
            <div class="upload-form-group">
                <label>Content Type *</label>
                <select id="content-type" required>
                    <option value="">Select type...</option>
                    <option value="Video">Video</option>
                    <option value="Document">Document</option>
                    <option value="Presentation">Presentation</option>
                    <option value="Quiz">Quiz</option>
                    <option value="Exercise">Exercise</option>
                </select>
            </div>
            <div class="upload-form-group">
                <label>File URL *</label>
                <input type="url" id="file-url" required placeholder="https://example.com/file">
            </div>
            <div class="upload-form-group">
                <label>Topic (Optional)</label>
                <select id="topic-id">
                    <option value="">Select topic...</option>
                    {% for topic in topics %}
                    <option value="{{ topic.topic_id }}">{{ topic.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn-upload">Upload Content</button>
        </form>
    </div>
</div>

<!-- Students Tab -->
<div id="students" class="tab-content">
    <div class="content-card">
        {% if enrolled_students and enrolled_students|length > 0 %}
            <h5 style="margin-bottom: 20px;">Enrolled Students ({{ enrolled_students|length }})</h5>
            <ul class="students-list">
                {% for student in enrolled_students %}
                <li class="student-item">
                    <div class="student-info">
                        <h6>{{ student.student_name }}</h6>
                        <p>Enrolled: {{ student.enrollment_date or 'N/A' }}</p>
                        <p style="font-size:12px;color:var(--text-muted);">{{ student.student_email or '' }}</p>
                    </div>
                    <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end;">
                        <button class="btn btn-sm btn-primary" onclick="openStudentProfile({{ student.student_user_id }})" style="padding:6px 10px;">View Profile</button>
                        <span class="progress-badge {% if student.completion_status == 'Completed' %}progress-completed{% elif student.completion_status == 'In Progress' %}progress-ongoing{% else %}progress-pending{% endif %}">
                            {{ student.completion_status or 'Enrolled' }}
                        </span>
                    </div>
                </li>
                {% endfor %}
            </ul>
        {% else %}
            <div class="empty-state">
                <h5>No Students Enrolled Yet</h5>
                <p>Students will appear here once they enroll in this course.</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Reviews Tab -->
<div id="reviews" class="tab-content">
    <div class="reviews-section">
        {% if course_reviews and course_reviews|length > 0 %}
            <h5 style="margin-bottom: 20px;">Student Reviews ({{ course_reviews|length }})</h5>
            {% for review in course_reviews %}
            <div class="review-item">
                <div class="review-header">
                    <div>
                        <div class="review-author">{{ review.student_name or 'Anonymous' }}</div>
                        <div class="review-date">{{ review.rated_at or 'No date' }}</div>
                    </div>
                    <div class="rating-display">⭐ {{ review.rating or 'N/A' }}/5</div>
                </div>
                {% if review.review_text %}
                <div class="review-text">{{ review.review_text }}</div>
                {% else %}
                <div class="review-text" style="color: var(--text-muted);">No text provided</div>
                {% endif %}
            </div>
            {% endfor %}
        {% else %}
            <div class="empty-state">
                <h5>No Reviews Yet</h5>
                <p>Students will be able to leave reviews once they complete the course.</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Analytics Tab -->
<div id="analytics" class="tab-content">
    <div class="analytics-grid">
        <div class="analytics-card">
            <h6>Total Enrollments</h6>
            <h3>{{ analytics.total_enrollments or 0 }}</h3>
        </div>
        <div class="analytics-card">
            <h6>Completion Rate</h6>
            <h3>{{ analytics.completion_rate or 0 }}%</h3>
        </div>
        <div class="analytics-card">
            <h6>Average Rating</h6>
            <h3>{{ analytics.average_rating or 'N/A' }}</h3>
        </div>
        <div class="analytics-card">
            <h6>Dropout Rate</h6>
            <h3>{{ analytics.dropout_rate or 0 }}%</h3>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-md-6">
            <div class="chart-card content-card">
                <h5>Enrollment Breakdown</h5>
                <canvas id="enrollmentChart" style="max-height: 250px;"></canvas>
            </div>
        </div>
        <div class="col-md-6">
            <div class="chart-card content-card">
                <h5>Completion Status</h5>
                <canvas id="completionChart" style="max-height: 250px;"></canvas>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
    // Tab switching
    function switchTab(tabName) {
        // Hide all tabs
        const tabs = document.querySelectorAll('.tab-content');
        tabs.forEach(tab => tab.classList.remove('active'));
        
        // Remove active class from all nav links
        const navLinks = document.querySelectorAll('.nav-link');
        navLinks.forEach(link => link.classList.remove('active'));
        
        // Show selected tab
        document.getElementById(tabName).classList.add('active');
        
        // Add active class to clicked nav link
        event.target.classList.add('active');

        // Initialize charts when analytics tab is opened
        if (tabName === 'analytics') {
            setTimeout(initCharts, 100);
        }
    }

    // Upload content handler
    function uploadContent(event) {
        event.preventDefault();
        
        const formData = {
            course_id: {{ course.course_id }},
            title: document.getElementById('content-title').value,
            content_type: document.getElementById('content-type').value,
            file_url: document.getElementById('file-url').value,
            topic_id: document.getElementById('topic-id').value || null
        };

        // Call upload API
        fetch('{{ url_for("api_upload_content") }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer ' + localStorage.getItem('token')
            },
            body: JSON.stringify(formData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Content uploaded successfully!');
                document.getElementById('upload-form').reset();
                location.reload();
            } else {
                alert('Upload failed: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => console.error('Error:', error));
    }

    // Open student profile (sets selected student and token, then navigates)
    function openStudentProfile(studentId) {
        try {
            localStorage.setItem('selectedStudentId', studentId);
            // store the current session token so the profile page can fetch data
            localStorage.setItem('adminToken', '{{ token | escape }}');
        } catch (e) {
            console.warn('Could not save student id to localStorage', e);
        }
        window.location.href = '/student-profile';
    }

    // Initialize charts
    function initCharts() {
        const enrollmentCtx = document.getElementById('enrollmentChart');
        const completionCtx = document.getElementById('completionChart');

        if (enrollmentCtx) {
            new Chart(enrollmentCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Completed', 'In Progress', 'Not Started'],
                    datasets: [{
                        data: [
                            {{ analytics.completed_students or 0 }},
                            {{ analytics.active_students or 0 }},
                            {{ analytics.pending_students or 0 }}
                        ],
                        backgroundColor: ['#10B981', '#F59E0B', '#EF4444'],
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom' } }
                }
            });
        }

        if (completionCtx) {
            new Chart(completionCtx, {
                type: 'bar',
                data: {
                    labels: ['Completed', 'In Progress', 'Dropped'],
                    datasets: [{
                        label: 'Students',
                        data: [
                            {{ analytics.completed_students or 0 }},
                            {{ analytics.active_students or 0 }},
                            {{ analytics.dropout_count or 0 }}
                        ],
                        backgroundColor: '#8B5CF6',
                        borderColor: '#7C3AED',
                        borderWidth: 2,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
        }
    }
</script>
{% endblock %}
